---
import WorkLayout from '@layouts/WorkLayout.astro'
import ImageCarousel from '@components/ImageCarousel.astro'
import artemisSplashImage from '@media/artemis/artemis-splash-image.png'
import taskCalendarImage from '@media/artemis/gallery/task-calendar.png'
import templateEditImage from '@media/artemis/gallery/template-edit.png'
import yieldReportImage from '@media/artemis/gallery/yield-report.png'
import zoneMetricsImage from '@media/artemis/gallery/zone-metrics.png'
import { Image } from 'astro:assets'

const getControlId = (id) => `carousel-link-${id}`

const carouselSlides = [
	{
		id: 'artemisCalendar',
		title: 'Scheduling',
		description:
			'We mapped multi-week crop plans directly to actionable tasks so farm managers could keep people, plants, and schedules aligned.',
		asset: taskCalendarImage,
		alt: 'Artemis task calendar showing planned work',
	},
	{
		id: 'artemisTemplate',
		title: 'Planning',
		description:
			'The template editor allowed complex multi-step processes to be mapped out, automated, and adjusted to adapt to the latest metrics.',
		asset: templateEditImage,
		alt: 'Artemis crop template editor',
	},
	{
		id: 'artemisReports',
		title: 'Reporting',
		description:
			'Detailed yield and batch reports pulled every activity into an audit-friendly trail, helping farms stay compliant without extra work.',
		asset: yieldReportImage,
		alt: 'Artemis yield report chart',
	},
	{
		id: 'artemisData',
		title: 'Monitoring',
		description:
			'Zone metrics dashboards surfaced live climate and irrigation data so growers could correct issues before they impacted output.',
		asset: zoneMetricsImage,
		alt: 'Artemis zone metrics dashboard',
	},
]

export const frontmatter = {
	order: 3,
	title: 'Artemis',
	year: '2018 to 2021',
	position: 'Lead Product Designer',
	logo: 'artemis_logo_white.svg',
	logoOpen: 'artemis_logo_color.svg',
	workUrl: 'https://artemisag.com',
	color: 'rgb(255, 64, 22)',
	details: ['Acquired by IUNU'],
	description: `Artemis makes software to help farms grow. We helped simplify the complex management of people, plants, process, and legal compliance all in one place. At Artemis I was the lead designer through a significant redesign and refactor of the web and native apps to better serve large enterprise farms.`,
}
---

<WorkLayout {...frontmatter}>
	<div class="artemis-splash-image xyz-in" xyz="fade down duration-5 delay-7">
		<Image
			src={artemisSplashImage}
			width={artemisSplashImage.width}
			height={artemisSplashImage.height}
			alt="Artemis task timeline on a laptop and iPhone"
		/>
	</div>

	<div class="artemis-carousel-section" data-carousel="artemis">
		<div class="carousel-controls" role="tablist">
			{
				carouselSlides.map((slide, index) => (
					<button
						type="button"
						class="carousel-link"
						data-slide-id={slide.id}
						data-index={index}
						id={getControlId(slide.id)}
						aria-controls={slide.id}
						role="tab"
						aria-selected="false"
					>
						{slide.title}
					</button>
				))
			}
		</div>
		<div class="carousel-stage">
			<button type="button" class="carousel-nav-button" data-direction="prev" aria-label="Show previous slide">
				<span aria-hidden="true">←</span>
			</button>
			<div class="artemis-carousel xyz-in" xyz="stagger-1 fade small-3 down-2 delay-9">
				{
					carouselSlides.map((slide) => (
						<article
							class="carousel-item xyz-nested"
							id={slide.id}
							data-slide-id={slide.id}
							role="tabpanel"
							aria-labelledby={getControlId(slide.id)}
						>
							<Image
								class="carousel-item-image"
								src={slide.asset}
								width={slide.asset.width}
								height={slide.asset.height}
								alt={slide.alt}
								loading="lazy"
							/>
							<div class="carousel-item-caption">
								<p>{slide.description}</p>
							</div>
						</article>
					))
				}
			</div>
			<button type="button" class="carousel-nav-button" data-direction="next" aria-label="Show next slide">
				<span aria-hidden="true">→</span>
			</button>
		</div>
	</div>

	<!-- <div class="image-carousel-wrap">
		<ImageCarousel folder="artemis/gallery" width={300} />
	</div> -->

	<div class="page-section skill-section">
		<div class="skill-panel">
			<h3 class="skill-list-header">Pixels</h3>
			<ul class="skill-list">
				<li class="skill-list-item">Figma</li>
				<li class="skill-list-item">Adobe Suite</li>
				<li class="skill-list-item">Affinity Designer</li>
			</ul>
		</div>

		<div class="skill-panel">
			<h3 class="skill-list-header">Code</h3>
			<ul class="skill-list">
				<li class="skill-list-item">React</li>
				<li class="skill-list-item">Ruby</li>
				<li class="skill-list-item">SASS/CSS</li>
				<li class="skill-list-item">SVG</li>
				<li class="skill-list-item">GitHub</li>
			</ul>
		</div>
	</div>
</WorkLayout>

<script>
	const initCarousel = () => {
		const carouselRoot = document.querySelector('[data-carousel="artemis"]')
		// Avoid double-binding during Astro client-side transitions
		if (!carouselRoot || carouselRoot.dataset.carouselInitialized === 'true') return
		carouselRoot.dataset.carouselInitialized = 'true'

		// 1. Select Elements
		const container = carouselRoot.querySelector('.artemis-carousel')
		const slides = Array.from(container.querySelectorAll('.carousel-item'))
		const controls = Array.from(carouselRoot.querySelectorAll('.carousel-link'))
		const prevBtn = carouselRoot.querySelector('[data-direction="prev"]')
		const nextBtn = carouselRoot.querySelector('[data-direction="next"]')

		if (!container || slides.length === 0) return

		// 2. State Management
		// We map IDs to indices for O(1) lookups during interaction
		const slideMap = new Map(slides.map((slide, i) => [slide.id, i]))
		let currentIndex = 0

		// 3. Update UI (Tabs, Slides, Arrows)
		const updateActiveState = (index) => {
			currentIndex = index

			// Update Slides (for the scale/opacity CSS effect)
			slides.forEach((slide, i) => {
				slide.dataset.active = i === index ? 'true' : 'false'
			})

			// Update Tab Controls (highlight the active title)
			controls.forEach((control, i) => {
				const isActive = i === index
				control.dataset.active = isActive ? 'true' : 'false'
				control.setAttribute('aria-selected', isActive ? 'true' : 'false')
			})

			// Update Navigation Buttons (hide at start/end)
			if (prevBtn) {
				const shouldHide = index === 0
				prevBtn.classList.toggle('is-hidden', shouldHide)
				prevBtn.setAttribute('aria-hidden', String(shouldHide))
			}

			if (nextBtn) {
				const shouldHide = index === slides.length - 1
				nextBtn.classList.toggle('is-hidden', shouldHide)
				nextBtn.setAttribute('aria-hidden', String(shouldHide))
			}
		}

		// 4. The IntersectionObserver (The "Magic" Logic)
		// Triggers only when a slide moves > 55% into view.
		const observer = new IntersectionObserver(
			(entries) => {
				entries.forEach((entry) => {
					if (entry.isIntersecting) {
						const index = slideMap.get(entry.target.id)
						// Only update if we have a valid index
						if (index !== undefined) {
							updateActiveState(index)
						}
					}
				})
			},
			{
				root: container,
				threshold: 0.55, // Trigger when 55% of the slide is visible
			}
		)

		// Start watching all slides
		slides.forEach((slide) => observer.observe(slide))

		// 5. Click Interactions
		const scrollToSlide = (index) => {
			const slide = slides[index]
			if (!slide) return

			// CSS Scroll Snap handles the physics, we just point to the location
			slide.scrollIntoView({
				behavior: 'smooth',
				block: 'nearest',
				inline: 'center',
			})
		}

		// Tab Clicks
		controls.forEach((control) => {
			control.addEventListener('click', () => {
				const targetId = control.dataset.slideId
				const index = slideMap.get(targetId)
				if (index !== undefined) scrollToSlide(index)
			})
		})

		// Arrow Clicks
		prevBtn?.addEventListener('click', () => scrollToSlide(currentIndex - 1))
		nextBtn?.addEventListener('click', () => scrollToSlide(currentIndex + 1))

		// Initial check to set state on load
		updateActiveState(0)
	}

	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', initCarousel)
	} else {
		initCarousel()
	}

	document.addEventListener('astro:page-load', initCarousel)
</script>

<style lang="scss">
	@use '../../styles/_scssVariables' as *;

	.artemis-splash-image {
		max-width: 100%;
		padding: 0 var(--page-gutter);
		margin-bottom: var(--spacing-11);

		img {
			display: block;
			margin: 0 auto;
			max-width: 100%;
			width: 1024px;
			height: auto;
		}
	}

	.artemis-carousel-section {
		margin-block: var(--page-section-margin);
	}

	.carousel-stage {
		width: 100%;
		position: relative;
	}

	.carousel-controls {
		display: grid;
		grid-auto-flow: column;
		grid-auto-columns: 1fr;
		align-items: stretch;
		max-width: var(--page-content-width);
		padding: 0 var(--page-gutter);
		margin-inline: auto;
		margin-bottom: var(--spacing-8);
	}

	.carousel-link {
		text-align: left;
		// background-color: var(--bg-dark);
		padding: var(--spacing-6);
		display: grid;
		gap: var(--spacing-6);
		align-content: start;
		cursor: pointer;
		text-align: center;
		font-size: 1.125rem;
		line-height: 1.25;
		font-weight: 600;
		color: var(--page-color);
		transition:
			background-color 200ms ease-out,
			color 200ms ease-out,
			box-shadow 200ms ease-out;

		&:hover {
			background-color: hsl(from var(--page-color) h s l / 0.1);
		}

		&[data-active='true'] {
			background-color: var(--page-color);
			color: var(--bg-dark);

			+ .carousel-link {
				background-color: hsl(from var(--page-color) h s l / 0.15);

				+ .carousel-link {
					background-color: hsl(from var(--page-color) h s l / 0.05);
				}
			}
		}

		&:has(+ [data-active='true']) {
			background-color: hsl(from var(--page-color) h s l / 0.15);
		}

		&:has(+ .carousel-link + [data-active='true']) {
			background-color: hsl(from var(--page-color) h s l / 0.05);
		}

		@media (width < $breakpoint-lg) {
			font-size: 1rem;
			padding-inline: var(--spacing-4);
		}

		@media (width < $breakpoint-md) {
			font-size: 0.875rem;
		}
	}

	.carousel-nav-button {
		position: absolute;
		top: 50%;
		transform: translateY(-50%);
		width: 3rem;
		height: 3rem;
		border-radius: 999px;
		border: 1px solid var(--page-color);
		background-color: var(--bg-dark);
		color: var(--text-light);
		display: grid;
		place-items: center;
		cursor: pointer;
		font-size: 1.25rem;
		line-height: 1;
		z-index: 1;
		transition: 200ms ease-out;
		transition-property: background-color, color, border;

		&[data-direction='prev'] {
			left: var(--spacing-8);
		}

		&[data-direction='next'] {
			right: var(--spacing-8);
		}

		&:hover {
			color: var(--page-color);
			border-width: 2px;
		}

		&.is-hidden {
			display: none;
		}
	}

	.artemis-carousel {
		width: 100%;
		display: grid;
		grid-auto-flow: column;
		margin-inline: auto;
		padding-bottom: var(--page-gutter);
		gap: var(--spacing-10);
		overflow-x: scroll;
		overflow-y: clip;
		scroll-behavior: smooth;
		scroll-snap-type: x mandatory;
		scrollbar-width: 0;

		&::before,
		&::after {
			content: '';
			display: block;
			width: 50vw;
		}

		@media (width < $breakpoint-lg) {
			gap: var(--spacing-4);
		}
	}

	.carousel-item {
		width: 70vw;
		max-width: $breakpoint-xl;
		position: relative;
		scroll-snap-align: center;
		scroll-snap-stop: always;

		&[data-active='true'] {
			.carousel-item-image {
				scale: 1;
				filter: saturate(100%) opacity(100%);
			}

			.carousel-item-caption {
				opacity: 1;
				translate: -50% 0;

				@media (width < $breakpoint-lg) {
					translate: 0;
				}
			}
		}

		@media (width < $breakpoint-lg) {
			width: 85vw;
		}
	}

	.carousel-item-image {
		display: block;
		width: 100%;
		height: auto;
		transition: 250ms ease-out;
		transition-property: scale, filter;
		scale: 0.95;
		filter: saturate(50%) opacity(25%);
	}

	.carousel-item-caption {
		position: absolute;
		bottom: calc(var(--spacing-6) * -1);
		left: 50%;
		background-color: var(--bg-dark);
		padding: var(--spacing-8);
		border: 1px solid var(--page-color);
		width: 32rem;
		opacity: 0;
		translate: -50% 24px;
		transition: 250ms ease-out 250ms;
		transition-property: opacity, translate;

		p {
			color: var(--text-color);
			font-size: 1rem;
		}

		@media (width < $breakpoint-lg) {
			position: relative;
			left: initial;
			bottom: initial;
			translate: 0 24px;
			width: 100%;
			transition-delay: 0;
		}
	}
</style>
