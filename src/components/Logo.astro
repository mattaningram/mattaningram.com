---
//M Logo Component
const files = import.meta.glob('/public/assets/mLogos/**/*.{svg,html}', {
	eager: true,
	as: 'url',
})
const urls = Object.values(files).map((url) => url.replace(/^\/public/, ''))
---

<div class="m-logo-wrap"></div>

<script is:inline define:vars={{ urls }}>
	// Scope to this component instance by using the adjacent wrapper element
	const logoWrap = document.currentScript?.previousElementSibling
	if (!(logoWrap instanceof HTMLElement)) {
		console.warn('[Logo] Wrapper element not found; skipping init')
		return
	}
	let logoList = shuffle([...urls])
	let currentIndex = 0

	function shuffle(array) {
		let m = array.length,
			t,
			i
		while (m) {
			i = Math.floor(Math.random() * m--)
			t = array[m]
			array[m] = array[i]
			array[i] = t
		}
		return array
	}

	//SPIDER LINES FUNCTION
	function runSpiderLines() {
		var numLines = 240
		var radius = 75
		var lineWrap = document.querySelector('.m-logo-random-lines')
		if (!lineWrap) return
		var lines = document.createDocumentFragment()

		for (var i = 0; i < numLines; i++) {
			var rand1 = -Math.PI + Math.random() * Math.PI * 2
			var rand2 = -Math.PI + Math.random() * Math.PI * 2
			var line = document.createElementNS('http://www.w3.org/2000/svg', 'line')
			line.setAttribute('x1', 50 + radius * Math.cos(rand1))
			line.setAttribute('y1', 50 + radius * Math.sin(rand1))
			line.setAttribute('x2', 50 + radius * Math.cos(rand2))
			line.setAttribute('y2', 50 + radius * Math.sin(rand2))
			line.setAttribute('vector-effect', 'non-scaling-stroke')
			line.setAttribute(
				'style',
				'animation-delay: ' + Math.random() * 1.5 + 's; opacity: ' + (0.1 + Math.random() * 0.9) + ';'
			)
			lines.appendChild(line)
		}
		lineWrap.appendChild(lines)
	}

	async function renderLogo(index) {
		const url = logoList[index]
		const res = await fetch(url)
		const html = await res.text()
		logoWrap.innerHTML = html
		if (url.includes('mSpiderLines')) {
			runSpiderLines()
		}

		// After injecting the logo HTML, remove `xyz-in` once its intro animation finishes
		xyzCleanup(logoWrap)
	}

	function xyzCleanup(root) {
		if (!(root instanceof HTMLElement)) return
		const elements = root.querySelectorAll('.xyz-in')
		elements.forEach((el) => {
			const removeClass = () => el.classList.remove('xyz-in')
			el.addEventListener('animationend', removeClass, { once: true })
			// Fallback timer using computed animation duration + delay
			const cs = getComputedStyle(el)
			const toMs = (v) => {
				const s = String(v).trim()
				if (s.endsWith('ms')) return parseFloat(s) || 0
				return (parseFloat(s) || 0) * 1000
			}
			const durations = cs.animationDuration.split(',').map(toMs)
			const delays = cs.animationDelay.split(',').map(toMs)
			const maxMs = durations.reduce((acc, d, i) => Math.max(acc, d + (delays[i] || 0)), 0)
			if (maxMs > 0) {
				setTimeout(removeClass, maxMs + 50)
			}
		})
	}

	logoWrap.addEventListener('click', () => {
		currentIndex = (currentIndex + 1) % logoList.length
		renderLogo(currentIndex)
	})

	// Allow external triggers via CustomEvent on this instance
	logoWrap.addEventListener('m-logo:next', (ev) => {
		const detail = /** @type {CustomEvent | undefined} */ (ev)?.detail
		const nextIndex = typeof detail?.index === 'number' ? detail.index : currentIndex + 1
		currentIndex = ((nextIndex % logoList.length) + logoList.length) % logoList.length
		renderLogo(currentIndex)
	})

	// Initial render
	renderLogo(currentIndex)
</script>
