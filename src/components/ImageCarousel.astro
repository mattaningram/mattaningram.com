---
import type { ImageMetadata } from 'astro'
import { Image } from 'astro:assets'

interface Props {
	folder?: string
	width?: number
}

const images = import.meta.glob<{ default: ImageMetadata }>('@media/**/*.{jpg,jpeg,png,webp,gif}')

const { folder: folderProp, width = 300 } = Astro.props as Props

// Normalize provided folder path (strip leading/trailing slashes)
const folder = folderProp?.replace(/^\/+|\/+$/g, '')

// Build a filtered, stably-ordered list of image loaders
let entries = Object.entries(images)
if (folder) {
	// Match only images inside the specified subfolder of src/media
	const segment = `/${folder}/`
	entries = entries.filter(([p]) => p.includes(segment))
}
entries.sort(([a], [b]) => a.localeCompare(b))
---

<ul class="photoswipe-gallery image-carousel xyz-in" xyz="fade down ease-out-back">
	{
		entries.map(async ([_path, image], index) => {
			const { default: imageData } = await image()
			const altText =
				_path
					.split('/')
					.pop()
					?.replace(/\.[^.]+$/, '')
					?.replace(/^\d+\./, '')
					?.replace(/-/g, ' ')
					?.trim() ?? ''
			return (
				<li class="carousel-item gallery-item xyz-nested">
					<a
						class="carousel-link no-outline"
						href={imageData.src}
						data-pswp-width={imageData.width}
						data-pswp-height={imageData.height}
					>
						<Image
							class="carousel-image"
							layout="fixed"
							src={imageData}
							alt={altText}
							width={width}
							fit="scale-down"
							loading={index < 20 ? 'eager' : 'lazy'}
						/>
					</a>
				</li>
			)
		})
	}
</ul>

<style lang="scss">
	.image-carousel {
		--xyz-delay: 0.8s;
		--xyz-stagger: 0.1s;
		list-style: none;
		overflow-x: scroll;
		display: flex;
		align-items: flex-start;
		justify-content: flex-start;
		gap: var(--spacing-10);
		padding: var(--spacing-10) var(--page-gutter);
	}

	.carousel-item {
		display: block;
		flex-shrink: 0;
		height: auto;
		vertical-align: top;
		position: relative;
		box-shadow: var(--shadow-md);
		transition: 0.2s var(--ease-out-quad);
		transition-property: transform, box-shadow;

		&:hover,
		&:focus-within {
			transform: translate3d(0, -16px, 0);
			box-shadow: 0 0 0 4px var(--page-color);
		}
	}

	.carousel-link {
		display: block;
	}

	.carousel-image {
		width: 100%;
		display: block;
	}
</style>
