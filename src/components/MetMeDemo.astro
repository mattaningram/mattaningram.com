<!-- Demo Animation Section -->
<section class="mm-demo" aria-label="How MetMe works">
	<div class="mm-demo__phone">
		<div class="mm-demo__island"></div>
		<div class="mm-demo__screen">
			<div class="mm-demo__prompt-container">
				<!-- Step 1: Prompt -->
				<p class="mm-demo__prompt">Who did you meet?</p>

				<!-- Step 2: Text appears -->
				<div class="mm-demo__text">
					<span class="mm-demo__word">I</span>{' '}
					<span class="mm-demo__word">met</span>{' '}
					<span class="mm-demo__word" data-field="name">Michele Mouton</span>{' '}
					<span class="mm-demo__word">a</span>{' '}
					<span class="mm-demo__word" data-field="title">driver</span>{' '}
					<span class="mm-demo__word">at</span>{' '}
					<span class="mm-demo__word" data-field="company">Group B Rally</span>{' '}
					<span class="mm-demo__word" data-field="phone">415-555-9876</span>{' '}
					<span class="mm-demo__word" data-field="email">michele@mouton.com</span>
				</div>
			</div>

			<!-- Step 3: Parsed contact card -->
			<div class="mm-demo__contact">
				<div class="mm-demo__contact-row">
					<span class="mm-demo__contact-label">Name</span>
					<span class="mm-demo__contact-value">Michele Mouton</span>
				</div>
				<div class="mm-demo__contact-row">
					<span class="mm-demo__contact-label">Company</span>
					<span class="mm-demo__contact-value">Group B Rally</span>
				</div>
				<div class="mm-demo__contact-row">
					<span class="mm-demo__contact-label">Title</span>
					<span class="mm-demo__contact-value">Driver</span>
				</div>
				<div class="mm-demo__contact-row">
					<span class="mm-demo__contact-label">Phone</span>
					<span class="mm-demo__contact-value">415-555-9876</span>
				</div>
				<div class="mm-demo__contact-row">
					<span class="mm-demo__contact-label">Email</span>
					<span class="mm-demo__contact-value">michele@mouton.com</span>
				</div>
			</div>

			<!-- Delete button -->
			<div class="mm-demo__delete">
				<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
					<path
						d="M3 6h18M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2m3 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6h14"
						stroke="currentColor"
						stroke-width="1.5"
						stroke-linecap="round"
						stroke-linejoin="round"></path>
				</svg>
			</div>

			<!-- Save button -->
			<div class="mm-demo__save">
				<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
					<path
						d="M20 6L9 17l-5-5"
						stroke="currentColor"
						stroke-width="2.5"
						stroke-linecap="round"
						stroke-linejoin="round"></path>
				</svg>
			</div>

			<!-- Context pill and mic button container -->
			<div class="mm-demo__input-container">
				<!-- Context pill -->
				<div class="mm-demo__context-pill">
					<span class="mm-demo__context-item">
						<svg viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"
							><rect x="1" y="3" width="14" height="12" rx="1.5" stroke="currentColor" stroke-width="1.2"></rect><path
								d="M1 6.5h14M5 1v4M11 1v4"
								stroke="currentColor"
								stroke-width="1.2"
								stroke-linecap="round"></path></svg
						>
						Today
					</span>
					<span class="mm-demo__context-divider"></span>
					<span class="mm-demo__context-item">
						<svg viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"
							><path
								d="M10 1.5l-1.5 13M7.5 1.5L6 14.5M2.5 5.5h11M2 10.5h11"
								stroke="currentColor"
								stroke-width="1.2"
								stroke-linecap="round"></path></svg
						>
						Here
					</span>
				</div>

				<!-- Mic button -->
				<div class="mm-demo__mic">
					<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
						<path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" fill="currentColor"></path>
						<path
							d="M19 10v2a7 7 0 0 1-14 0v-2M12 19v4m-4 0h8"
							stroke="currentColor"
							stroke-width="1.5"
							stroke-linecap="round"
							stroke-linejoin="round"></path>
					</svg>
				</div>
			</div>

			<!-- Saved confirmation popup -->
			<div class="mm-demo__saved">
				<div class="mm-demo__saved-icon">
					<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
						<path
							d="M20 6L9 17l-5-5"
							stroke="currentColor"
							stroke-width="2.5"
							stroke-linecap="round"
							stroke-linejoin="round"></path>
					</svg>
				</div>
				<p class="mm-demo__saved-name">Michele Mouton saved</p>
				<p class="mm-demo__saved-detail">Driver at Group B Rally</p>
				<p class="mm-demo__saved-detail">415-555-9876</p>
				<span class="mm-demo__saved-view">View contact</span>
			</div>
		</div>
	</div>
	<button class="mm-demo__pause" aria-label="Pause animation">
		<svg class="mm-demo__pause-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
			<rect x="6" y="4" width="4" height="16" rx="1" fill="currentColor"></rect>
			<rect x="14" y="4" width="4" height="16" rx="1" fill="currentColor"></rect>
		</svg>
		<svg
			class="mm-demo__play-icon"
			viewBox="0 0 24 24"
			fill="none"
			xmlns="http://www.w3.org/2000/svg"
			style="display:none"
		>
			<path d="M6 4l14 8-14 8V4z" fill="currentColor"></path>
		</svg>
	</button>
</section>

<script>
	import { animate, stagger, inView } from 'motion'

	let paused = false
	let abortController: AbortController | null = null

	function delay(ms: number, signal: AbortSignal): Promise<void> {
		return new Promise((resolve, reject) => {
			const id = setTimeout(resolve, ms)
			signal.addEventListener('abort', () => {
				clearTimeout(id)
				reject(new DOMException('Aborted', 'AbortError'))
			})
		})
	}

	function initDemoAnimation() {
		const demoSection = document.querySelector('.mm-demo')
		if (demoSection) {
			inView(
				demoSection,
				() => {
					startAnimation()
				},
				{ amount: 0.3 },
			)
		}

		const pauseBtn = document.querySelector('.mm-demo__pause')
		if (pauseBtn) {
			pauseBtn.addEventListener('click', togglePause)
		}
	}

	function startAnimation() {
		if (abortController) abortController.abort()
		abortController = new AbortController()
		runDemoAnimation(abortController.signal)
	}

	function togglePause() {
		const btn = document.querySelector('.mm-demo__pause') as HTMLElement
		const pauseIcon = btn?.querySelector('.mm-demo__pause-icon') as HTMLElement
		const playIcon = btn?.querySelector('.mm-demo__play-icon') as HTMLElement
		if (!btn) return

		paused = !paused
		if (paused) {
			// Stop the running animation
			if (abortController) abortController.abort()
			abortController = null
			pauseIcon.style.display = 'none'
			playIcon.style.display = ''
		} else {
			// Restart the animation
			pauseIcon.style.display = ''
			playIcon.style.display = 'none'
			startAnimation()
		}
	}

	async function runDemoAnimation(signal: AbortSignal) {
		const phone = document.querySelector('.mm-demo__phone') as HTMLElement
		const prompt = document.querySelector('.mm-demo__prompt') as HTMLElement
		const mic = document.querySelector('.mm-demo__mic') as HTMLElement
		const contextPill = document.querySelector('.mm-demo__context-pill') as HTMLElement
		const textWrap = document.querySelector('.mm-demo__text') as HTMLElement
		const words = document.querySelectorAll('.mm-demo__word')
		const contact = document.querySelector('.mm-demo__contact') as HTMLElement
		const contactRows = document.querySelectorAll('.mm-demo__contact-row')
		const deleteBtn = document.querySelector('.mm-demo__delete') as HTMLElement
		const saveBtn = document.querySelector('.mm-demo__save') as HTMLElement
		const saved = document.querySelector('.mm-demo__saved') as HTMLElement

		if (!phone || !prompt || !mic || !contextPill || !textWrap || !contact || !deleteBtn || !saveBtn || !saved) return

		try {
		// Phone enters (only on first run)
		if (phone.style.opacity !== '1') {
			await animate(
				phone,
				{ opacity: [0, 1], y: [60, 0], scale: [0.92, 1] } as any,
				{ duration: 0.8, easing: [0.25, 1, 0.5, 1] } as any,
			).finished
			phone.style.opacity = '1'
		}

			// Prompt fades in
			prompt.style.display = ''
			await animate(prompt, { opacity: [0, 1] }, { duration: 0.5 }).finished
			if (signal.aborted) return

			// Mic pulses
			mic.classList.add('mm-demo__mic--active')

			await delay(800, signal)

			// Prompt fades out, text appears
			await animate(prompt, { opacity: 0 }, { duration: 0.3 }).finished
			prompt.style.display = 'none'
			if (signal.aborted) return

		textWrap.style.display = 'block'
		await animate(
			words,
			{ opacity: [0, 1], y: [8, 0] } as any,
			{ duration: 0.35, delay: stagger(0.12), easing: [0.25, 1, 0.5, 1] } as any,
		).finished
			if (signal.aborted) return

			await delay(500, signal)

			// Mic stops pulsing
			mic.classList.remove('mm-demo__mic--active')

			// Amber gradient scan across the text
			textWrap.classList.add('mm-demo__text--scanning')
			await delay(2400, signal)
			textWrap.classList.remove('mm-demo__text--scanning')

			// Highlight parsed fields
			words.forEach((w) => {
				if ((w as HTMLElement).dataset.field) {
					;(w as HTMLElement).classList.add('mm-demo__word--highlighted')
				}
			})
			await delay(500, signal)

		// Contact card slides up
		contact.style.display = 'block'
		await animate(contact, { opacity: [0, 1], y: [20, 0] } as any, { duration: 0.5, easing: [0.25, 1, 0.5, 1] } as any).finished
		if (signal.aborted) return

		await animate(
			contactRows,
			{ opacity: [0, 1], x: [-10, 0] } as any,
			{ duration: 0.35, delay: stagger(0.08), easing: [0.25, 1, 0.5, 1] } as any,
		).finished
			if (signal.aborted) return

		// Delete and save buttons animate in
		animate(deleteBtn, { opacity: [0, 1], scale: [0.8, 1] } as any, { duration: 0.35, easing: [0.25, 1, 0.5, 1] } as any)
		await animate(
			saveBtn,
			{ opacity: [0, 1], scale: [0.8, 1] } as any,
			{ duration: 0.35, delay: 0.08, easing: [0.25, 1, 0.5, 1] } as any,
		).finished
			if (signal.aborted) return

			// Hold the completed state
			await delay(1800, signal)

		// Save button "tapped"
		await animate(
			saveBtn,
			{ scale: [1, 0.85], backgroundColor: ['oklch(35% 0.1 75)', 'oklch(65% 0.18 75)'] } as any,
			{ duration: 0.1, easing: 'ease-in' } as any,
		).finished
		await animate(
			saveBtn,
			{ scale: [0.85, 1], backgroundColor: ['oklch(65% 0.18 75)', 'oklch(35% 0.1 75)'] } as any,
			{ duration: 0.2, easing: [0.25, 1, 0.5, 1] } as any,
		).finished
			if (signal.aborted) return

			await delay(200, signal)

		// Contact card slides down and out, text animates out upward
		animate(contact, { opacity: 0, y: [0, '100%'] } as any, { duration: 0.4, easing: [0.5, 0, 0.75, 0] } as any)
		animate(textWrap, { opacity: 0, y: [0, '-100%'] } as any, { duration: 0.4, easing: [0.5, 0, 0.75, 0] } as any)
		// Fade out delete and save buttons
		animate(deleteBtn, { opacity: 0 }, { duration: 0.3 })
		await animate(saveBtn, { opacity: 0 }, { duration: 0.3 }).finished
			if (signal.aborted) return

		// Saved popup slides up from bottom
		await animate(saved, { opacity: [0, 1], y: [40, 0] } as any, { duration: 0.5, easing: [0.25, 1, 0.5, 1] } as any).finished
			if (signal.aborted) return

			// Hold saved state
			await delay(2200, signal)

			// Fade out saved popup
			await animate(saved, { opacity: 0 }, { duration: 0.4 }).finished
			if (signal.aborted) return

			// Reset all state for next loop
			contact.style.display = 'none'
			contact.style.opacity = ''
			contact.style.transform = ''
			textWrap.style.display = 'none'
			textWrap.style.opacity = ''
			textWrap.style.transform = ''
			textWrap.classList.remove('mm-demo__text--scanning')
			deleteBtn.style.opacity = ''
			deleteBtn.style.transform = ''
			saveBtn.style.opacity = ''
			saveBtn.style.transform = ''
			saved.style.opacity = ''
			saved.style.transform = ''
			words.forEach((w) => {
				;(w as HTMLElement).style.opacity = '0'
				;(w as HTMLElement).classList.remove('mm-demo__word--highlighted')
			})
			contactRows.forEach((r) => {
				;(r as HTMLElement).style.opacity = '0'
			})

			await delay(600, signal)

			// Loop
			runDemoAnimation(signal)
		} catch (e) {
			if (e instanceof DOMException && e.name === 'AbortError') return
			throw e
		}
	}

	// Run on load and on Astro page transitions
	document.addEventListener('astro:page-load', initDemoAnimation)
</script>

<style lang="scss">
	@use '../styles/scssVariables' as *;

	/* ── Demo Animation Section ── */
	.mm-demo {
		display: flex;
		flex-direction: column;
		align-items: center;
		padding: 4rem var(--page-gutter) 6rem;
	}

	.mm-demo__pause {
		display: flex;
		align-items: center;
		justify-content: center;
		width: 36px;
		height: 36px;
		margin-top: 1.25rem;
		border: none;
		border-radius: 50%;
		background: transparent;
		color: var(--stone-500);
		cursor: pointer;
		transition: color 0.2s ease;

		&:hover {
			color: var(--stone-300);
		}

		svg {
			width: 16px;
			height: 16px;
		}
	}

	.mm-demo__phone {
		position: relative;
		width: 300px;
		background: var(--stone-900);
		border: 1.5px solid var(--stone-700);
		border-radius: 40px;
		padding: 6px;
		box-shadow:
			0 25px 80px oklch(0% 0 0 / 0.6),
			0 0 60px oklch(76.9% 0.188 70.08 / 0.08);
		opacity: 0;

		@media (width >= $breakpoint-sm) {
			width: 340px;
			border-radius: 46px;
			padding: 7px;
		}
	}

	.mm-demo__island {
		position: absolute;
		top: 16px;
		left: 50%;
		transform: translateX(-50%);
		width: 72px;
		height: 20px;
		background: #000;
		border-radius: 10px;
		z-index: 10;

		@media (width >= $breakpoint-sm) {
			top: 18px;
			width: 80px;
			height: 22px;
			border-radius: 11px;
		}
	}

	.mm-demo__screen {
		position: relative;
		aspect-ratio: 9 / 19.5;
		background: linear-gradient(180deg, var(--stone-900) 0%, var(--stone-950) 100%);
		border-radius: 34px;
		overflow: hidden;
		display: flex;
		flex-direction: column;
		align-items: center;
		padding: 56px 0 22px;

		@media (width >= $breakpoint-sm) {
			border-radius: 39px;
			padding: 64px 0 26px;
		}
	}

	.mm-demo__prompt-container {
		padding: 0 22px;

		@media (width >= $breakpoint-sm) {
			padding: 0 26px;
		}
	}

	.mm-demo__prompt {
		font-size: 1.15rem;
		font-weight: 600;
		color: var(--amber-500);
		opacity: 0;
		align-self: flex-start;

		@media (width >= $breakpoint-sm) {
			font-size: 1.3rem;
		}
	}

	.mm-demo__text {
		display: none;
		font-size: 1.1rem;
		font-weight: 600;
		color: var(--amber-400);
		line-height: 1.5;
		align-self: flex-start;
		position: relative;

		@media (width >= $breakpoint-sm) {
			font-size: 1.2rem;
		}
	}

	.mm-demo__word {
		display: inline;
		opacity: 0;
		transition:
			color 0.4s ease,
			text-shadow 0.4s ease;
	}

	.mm-demo__word--highlighted {
		color: var(--amber-100);
		text-shadow: 0 0 12px oklch(76.9% 0.188 70.08 / 0.5);
	}

	/* Scanning amber gradient sweep – masked to text */
	.mm-demo__text--scanning {
		background: linear-gradient(
			135deg,
			var(--amber-400) 0%,
			var(--amber-400) 30%,
			var(--amber-100) 50%,
			var(--amber-400) 70%,
			var(--amber-400) 100%
		);
		background-size: 300% 100%;
		-webkit-background-clip: text;
		background-clip: text;
		-webkit-text-fill-color: transparent;
		animation: text-scan 1.2s ease-in-out forwards infinite;
	}

	@keyframes text-scan {
		0% {
			background-position: 100% 0;
		}
		100% {
			background-position: 0% 0;
		}
	}

	.mm-demo__contact {
		display: none;
		width: 100%;
		margin-top: auto;
		margin-bottom: 104px;
	}

	.mm-demo__contact-row {
		display: flex;
		justify-content: start;
		align-items: baseline;
		gap: 12px;
		padding: 8px 24px;
		border-bottom: 1px dashed oklch(26.8% 0.007 34.298 / 0.5);
		opacity: 0;
	}

	.mm-demo__contact-label {
		font-size: 0.65rem;
		width: 60px;
		color: var(--stone-500);
		text-transform: uppercase;
		letter-spacing: 0.04em;

		@media (width >= $breakpoint-sm) {
			width: 70px;
			font-size: 0.7rem;
		}
	}

	.mm-demo__contact-value {
		font-size: 0.85rem;
		font-weight: 500;
		color: var(--stone-100);

		@media (width >= $breakpoint-sm) {
			font-size: 0.9rem;
		}
	}

	.mm-demo__delete,
	.mm-demo__save {
		position: absolute;
		bottom: 28px;
		width: 40px;
		height: 40px;
		border-radius: 50%;
		display: grid;
		place-content: center;
		opacity: 0;

		svg {
			width: 18px;
			height: 18px;
		}

		@media (width >= $breakpoint-sm) {
			bottom: 32px;
			width: 44px;
			height: 44px;
		}
	}

	.mm-demo__delete {
		left: 20px;
		background: oklch(25% 0.05 25);
		border: 1px solid oklch(35% 0.08 25);
		color: oklch(60% 0.15 25);

		@media (width >= $breakpoint-sm) {
			left: 24px;
		}
	}

	.mm-demo__save {
		right: 20px;
		background: oklch(35% 0.1 75);
		border: 1px solid oklch(55% 0.15 75);
		color: var(--stone-50);

		@media (width >= $breakpoint-sm) {
			right: 24px;
		}
	}

	.mm-demo__saved {
		position: absolute;
		bottom: 0;
		left: 0;
		right: 0;
		display: flex;
		flex-direction: column;
		align-items: center;
		padding: 32px 24px 28px;
		background: linear-gradient(180deg, oklch(20% 0.04 160 / 0) 0%, oklch(25% 0.06 160) 30%, oklch(28% 0.07 155) 100%);
		border-radius: 0 0 34px 34px;
		opacity: 0;

		@media (width >= $breakpoint-sm) {
			border-radius: 0 0 39px 39px;
			padding: 36px 28px 32px;
		}
	}

	.mm-demo__saved-icon {
		width: 36px;
		height: 36px;
		border-radius: 50%;
		background: oklch(55% 0.12 160);
		display: grid;
		place-content: center;
		color: var(--stone-50);
		margin-bottom: 12px;

		svg {
			width: 18px;
			height: 18px;
		}
	}

	.mm-demo__saved-name {
		font-size: 0.95rem;
		font-weight: 600;
		color: var(--stone-50);
		margin-bottom: 4px;
	}

	.mm-demo__saved-detail {
		font-size: 0.78rem;
		color: oklch(70% 0.03 160);
		line-height: 1.4;
	}

	.mm-demo__saved-view {
		margin-top: 14px;
		font-size: 0.78rem;
		font-weight: 500;
		color: var(--stone-50);
		border: 1px solid oklch(70% 0.05 160 / 0.4);
		border-radius: 16px;
		padding: 5px 16px;
	}

	.mm-demo__input-container {
		display: grid;
		gap: 12px;
		justify-items: center;
		position: absolute;
		left: 50%;
		bottom: 24px;
		transform: translateX(-50%);

		@media (width >= $breakpoint-sm) {
			bottom: 28px;
		}
	}

	.mm-demo__context-pill {
		display: flex;
		gap: 0;
		background: var(--stone-800);
		border: 1px solid var(--stone-600);
		border-radius: 20px;
		white-space: nowrap;
		@media (width >= $breakpoint-sm) {
			bottom: 94px;
		}
	}

	.mm-demo__context-item {
		display: flex;
		align-items: center;
		gap: 6px;
		font-size: 11px;
		font-weight: 500;
		color: var(--stone-400);
		letter-spacing: 0.01em;
		padding: 3px 7px;

		svg {
			width: 12px;
			height: 12px;
			flex-shrink: 0;
		}

		@media (width >= $breakpoint-sm) {
			font-size: 12px;
			padding: 4px 8px;

			svg {
				width: 14px;
				height: 14px;
			}
		}
	}

	.mm-demo__context-divider {
		width: 0.5px;
		border-style: dashed;
		border-width: 1px;
		border-color: var(--stone-700);
	}

	.mm-demo__mic {
		width: 48px;
		height: 48px;
		background: var(--stone-800);
		border: 1px solid var(--stone-600);
		border-radius: 50%;
		display: grid;
		place-content: center;
		color: var(--stone-300);

		svg {
			width: 20px;
			height: 20px;
		}

		@media (width >= $breakpoint-sm) {
			width: 56px;
			height: 56px;
		}
	}

	.mm-demo__mic--active {
		animation: mic-pulse 1s ease-in-out infinite;
		color: var(--amber-400);
		border-color: var(--amber-500);
		background: oklch(27.9% 0.077 45.635);
	}

	@keyframes mic-pulse {
		0%,
		100% {
			box-shadow: 0 0 0 0 oklch(76.9% 0.188 70.08 / 0.3);
		}
		50% {
			box-shadow: 0 0 0 10px oklch(76.9% 0.188 70.08 / 0);
		}
	}
</style>
