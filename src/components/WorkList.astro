---
import type { ImageMetadata } from 'astro'
import WorkItem from '@components/WorkItem.astro'
import { Image } from 'astro:assets'

const logoModules = import.meta.glob<{ default: ImageMetadata }>('/src/logos/*.svg', { eager: true })

const { folder = 'work' } = Astro.props

// Preload both collections; choose one based on the `folder` prop.
const collections = {
  work: import.meta.glob('/src/pages/work/*.astro'),
  projects: import.meta.glob('/src/pages/projects/*.astro'),
} as const

const selected = collections[folder] ?? {}

const itemPaths = Object.keys(selected).map(
  (path) => `/${folder}/` + (path.match(new RegExp(`/${folder}/(.*)\\.astro$`))?.[1] ?? ''),
)

const itemModules = await Promise.all(Object.values(selected).map((loader) => loader()))

const itemsUnsorted = itemModules.map((item, i) => ({
  ...item.frontmatter,
  url: itemPaths[i],
  component: item.default,
}))

const items = itemsUnsorted
  .map((item) => {
    const logoFilename = item.logo
    const logoKey = logoFilename ? Object.keys(logoModules).find((k) => k.endsWith(`/${logoFilename}`)) : undefined
    const logoSrc: ImageMetadata | undefined = logoKey ? logoModules[logoKey].default : undefined
    return { ...item, logoSrc }
  })
  .sort((a, b) => b.order - a.order)
---

<div class="work-list-wrap" xyz="fade stagger-1 delay-10 down-2 small-2">
  {
    items.map((item) => (
      <WorkItem
        href={item.url}
        color={item.color}
        order={item.order}
        class="work-list-item xyz-in"
        transitionName={`work-${item.title.toLowerCase().replace(/\s+/g, '-')}-hero`}
      >
        {item.logoSrc ? (
          <Image class="work-item-logo" src={item.logoSrc} alt={`${item.title} Logo`} />
        ) : (
          <h3 class="work-item-title">{item.title}</h3>
        )}
      </WorkItem>
    ))
  }
</div>

<script>
  // A major pentatonic scale: A4, B4, C#5, E5, F#5
  const NOTE_FREQS = [440, 493.88, 554.37, 659.25, 739.99]

  let audioCtx: AudioContext | null = null

  function getCtx(): AudioContext {
    if (!audioCtx) {
      audioCtx = new AudioContext()
    }
    if (audioCtx.state === 'suspended') {
      audioCtx.resume()
    }
    return audioCtx
  }

  function playNote(order: number) {
    const ctx = getCtx()
    const freq = NOTE_FREQS[Math.min(order - 1, NOTE_FREQS.length - 1)]
    const now = ctx.currentTime

    const osc1 = ctx.createOscillator()
    const osc2 = ctx.createOscillator()
    const gainMain = ctx.createGain()
    const gainHarm = ctx.createGain()

    osc1.type = 'sine'
    osc1.frequency.value = freq
    osc2.type = 'sine'
    osc2.frequency.value = freq * 2

    gainHarm.gain.value = 0.3

    osc1.connect(gainMain)
    osc2.connect(gainHarm)
    gainHarm.connect(gainMain)
    gainMain.connect(ctx.destination)

    gainMain.gain.setValueAtTime(0, now)
    gainMain.gain.linearRampToValueAtTime(0.12, now + 0.01)
    gainMain.gain.exponentialRampToValueAtTime(0.001, now + 0.35)

    osc1.start(now)
    osc1.stop(now + 0.35)
    osc2.start(now)
    osc2.stop(now + 0.35)
  }

  function initHoverSounds() {
    const items = document.querySelectorAll<HTMLElement>('.work-item-wrap[data-order]')
    items.forEach((item) => {
      if (item.dataset.soundBound === 'true') return
      item.dataset.soundBound = 'true'
      item.addEventListener('mouseenter', () => {
        const order = parseInt(item.dataset.order ?? '1', 10)
        playNote(order)
      })
    })
  }

  document.addEventListener('astro:page-load', initHoverSounds)
</script>

<style lang="scss">
  @use '../styles/_scssVariables' as *;

  .work-list-wrap {
    width: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: stretch;
    gap: var(--spacing-11);
    transform-style: preserve-3d;

    @media (width < $breakpoint-md) {
      gap: var(--spacing-10);
    }

    @media (width < $breakpoint-sm) {
      gap: var(--spacing-8);
    }

    :global(.work-item-wrap) {
      height: 11rem;

      @media (width < $breakpoint-sm) {
        height: 7rem;
      }
    }
  }

  .work-item-logo {
    display: block;
    width: 100%;
    height: auto;
    max-width: 15rem;
    max-height: 3rem;
    margin: 0 auto;

    @media (width < $breakpoint-md) {
      max-width: 12rem;
      max-height: 2.5rem;
    }

    @media (width < $breakpoint-sm) {
      max-width: 8rem;
      max-height: 2rem;
    }
  }

  .work-item-title {
    display: block;
    font-size: 1.6em;
    font-weight: 300;
    text-align: center;
  }

  .work-item-details {
    display: block;
    color: rgba(255, 255, 255, 0.75);
  }
</style>
