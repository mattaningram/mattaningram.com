---
import type { ImageMetadata } from 'astro'
import WorkItem from '@components/WorkItem.astro'
import { Image } from 'astro:assets'

const logoModules = import.meta.glob<{ default: ImageMetadata }>('/src/logos/*.svg', { eager: true })

const { folder = 'work' } = Astro.props

// Preload both collections; choose one based on the `folder` prop.
const collections = {
  work: import.meta.glob('/src/pages/work/*.astro'),
  projects: import.meta.glob('/src/pages/projects/*.astro'),
} as const

const selected = collections[folder] ?? {}

const itemPaths = Object.keys(selected).map(
  (path) => `/${folder}/` + (path.match(new RegExp(`/${folder}/(.*)\\.astro$`))?.[1] ?? ''),
)

const itemModules = await Promise.all(Object.values(selected).map((loader) => loader()))

const itemsUnsorted = itemModules.map((item, i) => ({
  ...item.frontmatter,
  url: itemPaths[i],
  component: item.default,
}))

const items = itemsUnsorted
  .map((item) => {
    const logoFilename = item.logo
    const logoKey = logoFilename
      ? Object.keys(logoModules).find((k) => k.endsWith(`/${logoFilename}`))
      : undefined
    const logoSrc: ImageMetadata | undefined = logoKey ? logoModules[logoKey].default : undefined
    return { ...item, logoSrc }
  })
  .sort((a, b) => b.order - a.order)

---

<div class="work-list-wrap" xyz="fade stagger-1 delay-10 down-2 small-2">
  {
    items.map((item) => (
      <WorkItem
        href={item.url}
        color={item.color}
        class="work-list-item"
        transitionName={`work-${item.title.toLowerCase().replace(/\s+/g, '-')}-hero`}
      >
        {item.logoSrc ? (
          <Image
            class="work-item-logo"
            src={item.logoSrc}
            alt={`${item.title} Logo`}
          />
        ) : (
          <h3 class="work-item-title">{item.title}</h3>
        )}
      </WorkItem>
    ))
  }
</div>

<style lang="scss">
  @use '../styles/_scssVariables' as *;

  .work-list-wrap {
    width: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: stretch;
    gap: var(--spacing-11);
    transform-style: preserve-3d;

    @media (width < $breakpoint-md) {
      gap: var(--spacing-10);
    }

    @media (width < $breakpoint-sm) {
      gap: var(--spacing-8);
    }

    :global(.work-item-wrap) {
      height: 11rem;

      @media (width < $breakpoint-sm) {
        height: 7rem;
      }
    }
  }

  .work-item-logo {
    display: block;
    width: 100%;
    height: auto;
    max-width: 15rem;
    max-height: 3rem;
    margin: 0 auto;

    @media (width < $breakpoint-md) {
      max-width: 12rem;
      max-height: 2.5rem;
    }

    @media (width < $breakpoint-sm) {
      max-width: 8rem;
      max-height: 2rem;
    }
  }

  .work-item-title {
    display: block;
    font-size: 1.6em;
    font-weight: 300;
    text-align: center;
  }

  .work-item-details {
    display: block;
    color: rgba(255, 255, 255, 0.75);
  }
</style>
