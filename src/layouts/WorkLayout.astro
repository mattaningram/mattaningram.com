---
import BaseLayout from '@layouts/BaseLayout.astro'
import Button from '@components/Button.astro'
import Header from '@components/Header.astro'
import Footer from '@components/Footer.astro'
import PerspectiveScroll from '@components/PerspectiveScroll.astro'

export interface Props {
  title: string
  year: string
  position: string
  logo?: string
  logoOpen?: string
  workUrl?: string
  color: string
  description: string
  details?: string[]
}

const { title, year, position, logo, logoOpen, workUrl, color, description, details } = Astro.props
---

<BaseLayout title={title} pageColor={color} class={`work-layout ${title.toLowerCase().replace(/\s+/g, '-')}-wrap`}>
  <div class="work-background"></div>

  <Header />

  <main>
    <div class="work-header-wrap">
      <header
        class="work-header xyz-in"
        xyz="fade down duration-5 ease-out-back"
        transition:name={`work-${title.toLowerCase().replace(/\s+/g, '-')}-hero`}
      >
        <PerspectiveScroll perspective="600px">
          <div class="work-header-top">
            <div class="work-title-wrap xyz-in" xyz="fade left delay-4 ease-out-back">
              {
                logoOpen ? (
                  <img class="work-logo" src={`/assets/logos/${logoOpen}`} alt={`${title} Logo`} />
                ) : logo ? (
                  <img class="work-logo" src={`/assets/logos/${logo}`} alt={`${title} Logo`} />
                ) : (
                  <h1 class="work-title">{title}</h1>
                )
              }
            </div>
            {
              workUrl && (
                <Button href={workUrl} class="work-link" target="_blank">
                  Visit
                </Button>
              )
            }
          </div>

          <div class="work-header-bottom" xyz="fade narrow stagger delay-8 origin-left">
            <div class="work-detail xyz-in">
              <span class="xyz-nested" xyz="fade down-100% duration-8 delay-10">{position} &ndash; {year}</span>
            </div>
            {
              details &&
                details.map((detail) => (
                  <div class="work-detail xyz-in">
                    <span class="xyz-nested" xyz="fade down-100% duration-8 delay-10">
                      {detail}
                    </span>
                  </div>
                ))
            }
          </div>
        </PerspectiveScroll>
      </header>
    </div>

    <div class="grab-copy-wrap xyz-in" xyz="fade down duration-4 delay-6 ease-out-back">
      <p class="grab-copy" set:html={description} />
    </div>

    <slot />
  </main>

  <Footer />
</BaseLayout>

<script>
  import PhotoSwipeLightbox from 'photoswipe/lightbox'
  import 'photoswipe/style.css'

  let lightbox

  const initLightbox = () => {
    const galleries = document.querySelectorAll('.photoswipe-gallery')

    // Clean up any previous instance before wiring up new DOM
    lightbox?.destroy()
    lightbox = undefined

    if (!galleries.length) {
      return
    }

    lightbox = new PhotoSwipeLightbox({
      gallery: '.photoswipe-gallery',
      children: 'a',
      pswpModule: () => import('photoswipe'),
      zoom: false,
      counter: false,
      padding: { top: 24, bottom: 24, left: 24, right: 24 },
    })

    lightbox.init()
  }

  const disableWorkHeaderTransition = () => {
    const header = document.querySelector('.work-header')
    if (!(header instanceof HTMLElement)) return
    header.style.setProperty('view-transition-name', 'none')
  }

  document.addEventListener('astro:before-swap', () => {
    lightbox?.destroy()
    lightbox = undefined
  })

  document.addEventListener('astro:before-preparation', disableWorkHeaderTransition)

  document.addEventListener('astro:page-load', initLightbox)

  initLightbox()
</script>

<style lang="scss">
  @use '../styles/scssVariables' as *;

  .work-header-wrap {
    width: var(--page-content-width);
    max-width: 100%;
    margin: 0 auto;
    padding: 0 var(--page-gutter);
  }

  .work-header {
    background-color: var(--bg-dark);
    border: 1px solid var(--page-color);
    transform-style: preserve-3d;
  }

  .work-header-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--spacing-8);
    padding: var(--spacing-10);
    border-bottom: 1px solid var(--page-color);
    transform-style: preserve-3d;

    @media (width < $breakpoint-sm) {
      padding: var(--spacing-8);
    }

    @media (width < $breakpoint-xs) {
      flex-direction: column;
    }
  }

  .work-header-bottom {
    display: flex;
    justify-content: flex-start;
    flex-wrap: wrap;
    margin-bottom: -1px;
    margin-right: -1px;
    transform-style: preserve-3d;
  }

  .work-background {
    position: fixed;
    inset: 0;
    z-index: -1;
    opacity: 0.25;
    background-image: radial-gradient(circle at top, var(--page-color), var(--bg-color) 65%);
    background-size: 100% 300%;
    background-position-y: 60%;
  }

  .work-title {
    font-size: 2.2em;
    text-align: center;
  }

  .work-logo {
    display: block;
    width: 100%;

    max-width: 240px;
    max-height: 48px;

    @media (width < $breakpoint-sm) {
      max-width: 180px;
      max-height: 36px;
    }
  }

  a.work-link {
    height: 3rem;
    width: 8rem;
    margin: 0;
    text-decoration: none;

    @media (width < $breakpoint-sm) {
      height: 2.5rem;
      width: 6rem;
    }
  }

  .work-detail {
    background-color: var(--bg-color);
    height: 3rem;
    display: flex;
    justify-content: center;
    width: fit-content;
    align-items: center;
    border-bottom: 1px solid var(--page-color);
    border-right: 1px solid var(--page-color);
    padding: 0 var(--spacing-8);
    color: var(--page-color);
    font-size: 0.875rem;
    font-weight: 400;
    text-align: center;

    @media (width < $breakpoint-md) {
      flex-grow: 1;
      padding: 0 var(--spacing-5);
    }
  }
</style>

<style lang="scss" is:global>
  @use '../styles/scssVariables' as *;

  .page-section {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    max-width: var(--page-content-width);
    padding: 0 var(--page-gutter);
    margin-inline: auto;
    margin-top: var(--page-section-margin);
  }

  .section-header {
    font-size: 2rem;
    color: var(--page-color);
    letter-spacing: 0.025em;
    align-self: flex-start;

    @media (width < $breakpoint-md) {
      font-size: 1.75rem;
      margin-bottom: var(--spacing-6);
    }
  }

  .section-text-wrap {
    position: relative;
    z-index: 1;
    display: flex;
    flex-grow: 1;
    background: var(--bg-dark);
    padding: var(--spacing-11);
    border: 1px solid var(--page-color);

    @media (width < $breakpoint-lg) {
      padding: var(--spacing-10);
    }

    @media (width < $breakpoint-md) {
      padding: var(--spacing-8);
    }
  }

  .section-text {
    display: grid;
    justify-items: start;
    gap: var(--spacing-8);

    @media (width < $breakpoint-md) {
      gap: var(--spacing-6);
    }
  }

  .page-section--row {
    align-items: center;
    justify-content: flex-start;

    .section-text {
      max-width: 27rem;
    }

    @media (width < $breakpoint-md) {
      display: block;

      .section-text-wrap {
        margin-bottom: calc(-1 * var(--spacing-7));
        padding-bottom: var(--spacing-11);
      }

      .section-text {
        max-width: 100%;
      }

      .section-content-block {
        margin: 0 calc(-1 * var(--page-gutter));
      }
    }
  }

  .page-section--top {
    display: block;

    .section-text-wrap {
      width: 100%;
      margin-bottom: calc(-1 * var(--spacing-7));
      &:not(:only-child) {
        padding-bottom: var(--spacing-14);
      }
    }

    .section-content-block {
      margin: 0 calc(-1 * var(--page-gutter));
    }
  }

  .page-section--left {
    @media (width >= $breakpoint-md) {
      .section-content-block {
        left: -30%;
      }
    }
  }

  .page-section--right {
    @media (width >= $breakpoint-md) {
      flex-direction: row-reverse;

      .section-text-wrap {
        justify-content: flex-end;
      }

      .section-content-block {
        right: -30%;
      }
    }
  }

  .section-content-block {
    align-self: stretch;
    position: relative;
    z-index: 2;
  }

  .section-image {
    position: absolute;
    display: block;
    max-width: initial;
  }

  .section-video {
    display: block;
    width: 100%;
    height: auto;
    box-shadow: var(--shadow-md);
  }

  //IMAGES

  .image-carousel-wrap {
    display: flex;
    justify-content: center;
    margin-bottom: var(--page-section-margin);
  }

  .gallery-item-link {
    display: block;

    img {
      display: block;
      box-shadow: var(--shadow-md);
      transition: 0.2s var(--ease-out-quad);
      transition-property: transform, box-shadow;
    }

    &:hover,
    &:focus {
      img {
        transform: translate3d(0, -16px, 0);
        box-shadow: 0 0 0 4px var(--page-color);
      }
    }
  }

  //SKILL SECTION

  .skill-section {
    align-items: stretch;
    flex-wrap: wrap;
    gap: var(--spacing-10);
    margin-top: var(--page-section-margin);

    @media (width < $breakpoint-md) {
      gap: var(--spacing-8);
    }

    .skill-panel {
      background-color: var(--bg-dark);
      border: 1px solid var(--page-color);
      display: flex;
      flex-direction: column;
      flex-grow: 1;
      width: 20rem;
    }
  }

  .skill-list-header {
    padding: var(--spacing-8);
    color: var(--page-color);
  }

  .skill-list {
    display: flex;
    flex-wrap: wrap-reverse;
    justify-content: flex-start;
    align-items: flex-start;
    max-width: 100%;
    list-style: none;
    padding: 0;
    margin-top: auto;
  }

  .skill-list-item {
    background: var(--bg-color);
    display: flex;
    align-items: center;
    height: 2rem;
    padding: 0 var(--spacing-5);
    border: 1px solid var(--page-color);
    margin-left: -1px;
    margin-bottom: -1px;
    color: var(--page-color);
    font-weight: 500;
  }
</style>
